<!doctype html>
<html>

<head>
    <title>PixiJs Test</title>

    <!-- development
    <script src="https://pixijs.download/release/pixi.js"></script>
 -->
    <!-- release
 -->
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <style>
        body,
        html {
            margin: 0px;
            height: 100%;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
        }
    </style>

</head>

<body>
    <script>
        const app = new PIXI.Application({
            width: 1600, height: 900, backgroundColor: 0x1099bb, resolution: window.devicePixelRatio || 1,
        });

        document.body.appendChild(app.view);

        // CONFIG
        const playerSpeed = 5

        const levels = [
            {
                canPlay: 1,
                player: {
                    x: 450,
                    y: 300,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 350,
                        y: 200,
                        w: 600,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 850,
                        y: 200,
                        w: 400,
                        h: 200
                    },
                    {
                        type: "ground",
                        x: 1050,
                        y: 200,
                        w: 200,
                        h: 500
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 650,
                        y: 650,
                        dist: 400,
                        rotation: 90
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 700,
                        y: 650,
                        dist: 400,
                        rotation: 90
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 750,
                        y: 650,
                        dist: 400,
                        rotation: 90
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 650,
                        dist: 400,
                        rotation: 90
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 850,
                        y: 650,
                        dist: 400,
                        rotation: 90
                    },
                    {
                        type: "goal",
                        x: 350,
                        y: 200,
                        w: 200,
                        h: 500
                    },
                    {
                        type: "coin",
                        x: 1150,
                        y: 600,
                    },
                ]
            },
            {
                player: {
                    x: 300,
                    y: 300,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 200,
                        y: 200,
                        w: 200,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 1200,
                        y: 200,
                        w: 200,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 200,
                        y: 500,
                        w: 500,
                        h: 200
                    },
                    {
                        type: "ground",
                        x: 500,
                        y: 200,
                        w: 200,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 500,
                        y: 200,
                        w: 600,
                        h: 200
                    },
                    {
                        type: "ground",
                        x: 900,
                        y: 200,
                        w: 200,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 900,
                        y: 500,
                        w: 500,
                        h: 200
                    },
                    {
                        type: "ground",
                        x: 750,
                        y: 300,
                        w: 100,
                        h: 200
                    },
                    {
                        type: "coin",
                        x: 800,
                        y: 250,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 300,
                        dist: 400,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 350,
                        dist: 400,
                        centered: true,
                    },
                    {
                        type: "coin",
                        x: 450,
                        y: 650,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 450,
                        y: 600,
                        dist: 400,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 450,
                        y: 550,
                        dist: 400,
                        centered: true,
                    },
                    {
                        type: "coin",
                        x: 1150,
                        y: 650,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 1150,
                        y: 550,
                        dist: 400,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 1150,
                        y: 600,
                        dist: 400,
                        centered: true,
                    },
                    {
                        type: "goal",
                        x: 750,
                        y: 400,
                        w: 100,
                        h: 100
                    },
                    {
                        type: "goal",
                        x: 200,
                        y: 200,
                        w: 200,
                        h: 200
                    },
                    {
                        type: "goal",
                        x: 1200,
                        y: 200,
                        w: 200,
                        h: 200
                    },
                ]
            },
            {
                player: {
                    x: 275,
                    y: 575,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 200,
                        y: 400,
                        w: 1200,
                        h: 100
                    },
                    {
                        type: "ground",
                        x: 200,
                        y: 400,
                        w: 150,
                        h: 250
                    },
                    {
                        type: "ground",
                        x: 400,
                        y: 300,
                        w: 100,
                        h: 200
                    },
                    {
                        type: "ground",
                        x: 600,
                        y: 400,
                        w: 100,
                        h: 200
                    },
                    {
                        type: "ground",
                        x: 800,
                        y: 300,
                        w: 100,
                        h: 200
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 750,
                        y: 450,
                        dist: 1000,
                        centered: true,
                    },
                    {
                        type: "goal",
                        x: 200,
                        y: 500,
                        w: 150,
                        h: 150
                    },
                    {
                        type: "coin",
                        x: 1350,
                        y: 450,
                    },
                ],
            },
            {
                player: {
                    x: 275,
                    y: 625,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 200,
                        y: 200,
                        w: 1200,
                        h: 500
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 750,
                        y: 450,
                        dist: 550,
                        rotation: -45,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 850,
                        y: 450,
                        dist: 550,
                        rotation: -45,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        offset: 1100 / 2,
                        dist: 1100,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 400,
                        offset: -1100 / 2,
                        dist: 1100,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 500,
                        offset: -1100 / 2,
                        dist: 1100,
                        centered: true,
                    },
                    {
                        type: "goal",
                        x: 200,
                        y: 550,
                        w: 150,
                        h: 150
                    },
                    {
                        type: "goal",
                        x: 1250,
                        y: 200,
                        w: 150,
                        h: 150
                    },
                    {
                        type: "coin",
                        x: 750,
                        y: 250,
                    },
                    {
                        type: "coin",
                        x: 850,
                        y: 650,
                    },
                ]
            },
            {
                player: {
                    x: 225,
                    y: 625,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 150,
                        y: 550,
                        w: 300,
                        h: 150
                    },
                    {
                        type: "ground",
                        x: 300,
                        y: 200,
                        w: 1000,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 1150,
                        y: 200,
                        w: 300,
                        h: 150
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 750,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 850,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 1250,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 1150,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 350,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 450,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 500,
                        dist: 800,
                        centered: true,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 400,
                        dist: 800,
                        centered: true,
                    },
                    {
                        type: "goal",
                        x: 150,
                        y: 550,
                        w: 150,
                        h: 150
                    },
                    {
                        type: "goal",
                        x: 1300,
                        y: 200,
                        w: 150,
                        h: 150
                    },
                    {
                        type: "coin",
                        x: 800,
                        y: 450,
                    },
                ]
            },
            {
                player: {
                    x: 300,
                    y: 450,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 550,
                        y: 200,
                        w: 500,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 600,
                        y: 150,
                        w: 400,
                        h: 600
                    },
                    {
                        type: "ground",
                        x: 500,
                        y: 250,
                        w: 600,
                        h: 400
                    },
                    {
                        type: "ground",
                        x: 250,
                        y: 400,
                        w: 1100,
                        h: 100
                    },
                    {
                        type: "ground",
                        x: 750,
                        y: 100,
                        w: 100,
                        h: 700
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 600,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 600,
                        offset: 100,
                        rotation: 30,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 600,
                        offset: 200,
                        rotation: 60,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 600,
                        offset: 300,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 600,
                        offset: 400,
                        rotation: 120,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 600,
                        offset: 500,
                        rotation: 150,
                        centered: true
                    },
                    {
                        type: "goal",
                        x: 250,
                        y: 400,
                        w: 100,
                        h: 100
                    },
                    {
                        type: "coin",
                        x: 1300,
                        y: 450,
                    },
                    {
                        type: "coin",
                        x: 600,
                        y: 250,
                    },
                    {
                        type: "coin",
                        x: 600,
                        y: 650,
                    },
                    {
                        type: "coin",
                        x: 1000,
                        y: 650,
                    },
                    {
                        type: "coin",
                        x: 1000,
                        y: 250,
                    },
                ],
            },
            {
                player: {
                    x: 1050,
                    y: 650,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 350,
                        y: 200,
                        w: 900,
                        h: 175
                    },
                    {
                        type: "ground",
                        x: 500,
                        y: 200,
                        w: 100,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 750,
                        y: 200,
                        w: 100,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 1000,
                        y: 200,
                        w: 100,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 500,
                        y: 500,
                        w: 600,
                        h: 100
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 250,
                        dist: 800,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 325,
                        dist: 800,
                        offset: 400,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 550,
                        dist: 500,
                        offset: 400,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        offset: 200,
                        dist: 400,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "goal",
                        x: 1000,
                        y: 600,
                        w: 100,
                        h: 100
                    },
                    {
                        type: "coin",
                        x: 550,
                        y: 287.5,
                    },
                    {
                        type: "coin",
                        x: 550,
                        y: 650,
                    },
                    {
                        type: "coin",
                        x: 1050,
                        y: 287.5,
                    },
                ],
            },
            {
                player: {
                    x: 1100,
                    y: 450,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 350,
                        y: 325,
                        w: 900,
                        h: 50
                    },
                    {
                        type: "ground",
                        x: 350,
                        y: 525,
                        w: 900,
                        h: 50
                    },
                    {
                        type: "ground",
                        x: 925,
                        y: 250,
                        w: 50,
                        h: 400
                    },
                    {
                        type: "ground",
                        x: 1150,
                        y: 325,
                        w: 50,
                        h: 250
                    },
                    {
                        type: "ground",
                        x: 1050,
                        y: 400,
                        w: 150,
                        h: 100
                    },
                    {
                        type: "ground",
                        x: 785,
                        y: 200,
                        w: 30,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 625,
                        y: 250,
                        w: 50,
                        h: 400
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 550,
                        dist: 800,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 350,
                        offset: -200,
                        dist: 800,
                        centered: true
                    },
                    {
                        type: "goal",
                        x: 1050,
                        y: 400,
                        w: 100,
                        h: 100
                    },
                    {
                        type: "coin",
                        x: 450,
                        y: 550,
                    },
                    {
                        type: "coin",
                        x: 450,
                        y: 350,
                    },
                ],
            },
            {
                player: {
                    x: 350,
                    y: 450,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 300,
                        y: 400,
                        w: 200,
                        h: 100
                    },
                    {
                        type: "ground",
                        x: 400,
                        y: 200,
                        w: 800,
                        h: 500
                    },
                    {
                        type: "ground",
                        x: 1100,
                        y: 400,
                        w: 200,
                        h: 100
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 500,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 575,
                        y: 450,
                        dist: 400,
                        rotation: -90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 650,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 725,
                        y: 450,
                        dist: 400,
                        rotation: -90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 875,
                        y: 450,
                        dist: 400,
                        rotation: -90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 950,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 1025,
                        y: 450,
                        dist: 400,
                        rotation: -90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 1100,
                        y: 450,
                        dist: 400,
                        rotation: 90,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 650,
                        dist: 700,
                        centered: true
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "linear",
                        x: 800,
                        y: 250,
                        dist: 700,
                        rotation: 180,
                        centered: true
                    },
                    {
                        type: "goal",
                        x: 300,
                        y: 400,
                        w: 100,
                        h: 100
                    },
                    {
                        type: "goal",
                        x: 1200,
                        y: 400,
                        w: 100,
                        h: 100
                    },
                    {
                        type: "coin",
                        x: 800,
                        y: 450,
                    },
                ]
            },
            {
                player: {
                    x: 1100,
                    y: 450,
                },
                size: 25,
                map: [
                    {
                        type: "ground",
                        x: 300,
                        y: 50,
                        w: 900,
                        h: 500
                    },

                    {
                        type: "enemy",
                        shape: "circle",
                        x: 800,
                        y: 250,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "circular",
                        radius: 50,
                        x: 800,
                        y: 250,
                        offset: 180
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "circular",
                        radius: 100,
                        x: 800,
                        y: 250,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "circular",
                        radius: 150,
                        x: 800,
                        y: 250,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "circular",
                        radius: 50,
                        x: 400,
                        y: 250,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "circular",
                        radius: 100,
                        speed: 5,
                        x: 400,
                        y: 250,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        movement: "circular",
                        invert: true,
                        radius: 150,
                        x: 400,
                        y: 250,
                    },
                    {
                        type: "enemy",
                        shape: "circle",
                        x: 400,
                        y: 250,
                    },
                    {
                        type: "coin",
                        x: 800,
                        y: 450,
                    },
                ],
            },
        ]


        var currentLevelNum = 0
        var lastLevelBeat = 0;
        var keys = []

        var scenes = {
            menuScene: new PIXI.Container(),
            gameScene: new PIXI.Container(),
            currentScene: undefined,
            ChangeScene: (sceneName) => {
                var scene;
                const prevScene = scenes.currentScene;
                switch (prevScene.sceneName) {
                    case "menu":
                        break;
                    case "game":
                        app.ticker.remove(GameTick)
                        app.ticker.remove(EndTick)
                        break;
                    default: break;
                }

                app.stage.removeChild(prevScene)

                switch (sceneName) {
                    case "menu":
                        createMenu()
                        scene = scenes.menuScene
                        break;
                    case "game":
                        scene = scenes.gameScene
                        app.ticker.add(GameTick)
                        break;
                    default:
                        console.error("ERROR: Unknown scene: " + sceneName)
                }
                scenes.currentScene = scene
                app.stage.addChild(scene)
            }
        }/* 
        scenes.gameScene.defaultLevel = 100 */
        scenes.gameScene.canPlayAll = true

        scenes.currentScene = scenes.menuScene

        scenes.menuScene.sceneName = "menu"
        scenes.gameScene.sceneName = "game"

        app.stage.addChild(scenes.currentScene)


        const baseSize = 100

        // UTILS

        function IsPlayerInsideRect(rect, addX, addY) {
            const player = scenes.gameScene.gameCanvas.player
            if (!player)
                return false

            const playerPos = { x: player.x + (addX || 0) - player.width / 2, y: player.y + (addY || 0) - player.height / 2 }

            return (playerPos.x + player.width - 5 < rect.x + rect.w &&
                playerPos.x > rect.x &&
                playerPos.y + player.height - 5 < rect.y + rect.h &&
                playerPos.y > rect.y)
        }

        function PlayerCollidesCircle(circle, radius, addX, addY) {
            const player = scenes.gameScene.gameCanvas.player
            if (!player)
                return false

            const playerPos = { x: player.x + (addX || 0) - player.width / 2, y: player.y + (addY || 0) - player.height / 2 }

            // temporary variables to set edges for testing
            var testX = circle.x;
            var testY = circle.y;

            // which edge is closest?
            if (circle.x < playerPos.x) testX = playerPos.x;      // test left edge
            else if (circle.x > playerPos.x + player.width) testX = playerPos.x + player.width   // right edge
            if (circle.y < playerPos.y) testY = playerPos.y;      // top edge
            else if (circle.y > playerPos.y + player.height) testY = playerPos.y + player.height;   // bottom edge

            // get distance from closest edges
            const distX = circle.x - testX;
            const distY = circle.y - testY;
            const distance = Math.sqrt((distX * distX) + (distY * distY));

            // if the distance is less than the radius, collision!
            if (distance <= radius) {
                return true;
            }

            return false;
        }

        // JOYSTICK
        const joystick = new PIXI.Graphics()
        scenes.gameScene.addChild(joystick)
        joystick.size = 75

        joystick.beginFill(0xFFFFFF, 0.0001);
        joystick.drawRect(0, 0, app.screen.width, app.screen.height)
        joystick.endFill()

        joystick.interactive = true

        joystick.static = new PIXI.Graphics()
        joystick.static.lineStyle(5, 0xFFFFFF, 0.75);
        joystick.static.beginFill(0xFFFFFF, 0.5);
        joystick.static.drawCircle(0, 0, joystick.size)
        if (!PIXI.isMobile.any)
            joystick.static.filters = [new PIXI.filters.BlurFilter(2)]

        joystick.draggable = new PIXI.Graphics()
        joystick.draggable.lineStyle(5, 0xFFFFFF, 0.75);
        joystick.draggable.beginFill(0xFFFFFF, 0.75);
        joystick.draggable.drawCircle(0, 0, joystick.size / 2)
        joystick.draggable.r = joystick.size * 2 / 3

        if (!PIXI.isMobile.any)
            joystick.draggable.filters = [new PIXI.filters.BlurFilter(2)]

        joystick.static.endFill()

        joystick.moveFn = function (deltaTime) {
            if (joystick.moveX > .1 || joystick.moveY > .1 || joystick.moveY < .1 || joystick.moveY < .1)
                MovePlayer(joystick.moveX, joystick.moveY, deltaTime)
        }

        joystick.onDragStart = function (event) {
            this.data = event.data
            this.dragging = true

            this.initialPosition = this.data.getLocalPosition(this.parent)

            scenes.gameScene.addChild(joystick.static)
            joystick.static.x = this.initialPosition.x
            joystick.static.y = this.initialPosition.y

            scenes.gameScene.addChild(joystick.draggable)
            joystick.draggable.x = this.initialPosition.x
            joystick.draggable.y = this.initialPosition.y

            app.ticker.add(joystick.moveFn)
            joystick.moveX = 0
            joystick.moveY = 0

        }
        joystick.onDragEnd = function () {
            this.dragging = false

            // set the interaction data to null
            this.data = null

            scenes.gameScene.removeChild(joystick.static)
            scenes.gameScene.removeChild(joystick.draggable)

            app.ticker.remove(joystick.moveFn)
        }
        joystick.onDragMove = function () {
            if (this.dragging) {
                const newPosition = this.data.getLocalPosition(this.parent)
                if (newPosition.y == this.initialPosition.y && newPosition.x == this.initialPosition.x) {
                    joystick.draggable.x = this.initialPosition.x
                    joystick.draggable.y = this.initialPosition.y
                    return
                }

                const m = (newPosition.y - this.initialPosition.y) / (newPosition.x - this.initialPosition.x)
                const angle = Math.atan(m)
                const distance =
                    Math.sqrt(
                        ((newPosition.x - this.initialPosition.x) * (newPosition.x - this.initialPosition.x)) +
                        ((newPosition.y - this.initialPosition.y) * (newPosition.y - this.initialPosition.y))) / joystick.draggable.r

                const clampedDistance = Math.max(Math.min(distance, 1), -1)

                const invert = Math.sign(newPosition.x - this.initialPosition.x) < 0 ? -1 : 1

                joystick.moveX = invert * clampedDistance * Math.cos(angle)
                joystick.moveY = invert * clampedDistance * Math.sin(angle)

                joystick.draggable.x = joystick.draggable.r * joystick.moveX + this.initialPosition.x
                joystick.draggable.y = joystick.draggable.r * joystick.moveY + this.initialPosition.y
            }
        }

        joystick.on('pointerdown', joystick.onDragStart)
            .on('pointerup', joystick.onDragEnd)
            .on('pointerupoutside', joystick.onDragEnd)
            .on('pointermove', joystick.onDragMove)


        // GAME

        scenes.gameScene.bg = new PIXI.Container()
        scenes.gameScene.addChild(scenes.gameScene.bg)

        scenes.gameScene.gameCanvas = new PIXI.Container()
        scenes.gameScene.addChild(scenes.gameScene.gameCanvas)

        scenes.gameScene.gameCanvas.y = 50 // margin top / 2

        scenes.gameScene.ui = new PIXI.Container()
        scenes.gameScene.addChild(scenes.gameScene.ui)

        const gameData = {
            enemyTime: 0,
            enemySpeed: 1,
        }

        const enemyTicker = new PIXI.Ticker()
        enemyTicker.add((deltaTime) => { gameData.enemyTime += gameData.enemySpeed * deltaTime * 1.5 })
        enemyTicker.start()

        const textStyle = {
            "fontSize": baseSize / 1.5,
            "align": "center",
            "fontFamily": "Verdana",
            "fontVariant": "small-caps"
        }



        EndTick = (deltaTime) => {
            scenes.gameScene.ui.endGameContainer.alpha += .05 * deltaTime
            if (scenes.gameScene.ui.endGameContainer.alpha > 1) {
                scenes.gameScene.ui.endGameContainer.alpha = 1
                app.ticker.remove(EndTick)
            }
        }

        function ResetUI() {
            scenes.gameScene.ui.removeChild(scenes.gameScene.ui.endGameContainer)
            scenes.gameScene.ui.endGameContainer.alpha = 0
        }


        function CreateUI() {
            scenes.gameScene.ui.endGameContainer = new PIXI.Container();
            scenes.gameScene.ui.endGameContainer.alpha = 0
            scenes.gameScene.ui.endGameContainer.x = app.screen.width / 2
            scenes.gameScene.ui.endGameContainer.y = app.screen.height / 2

            const endBg = new PIXI.Sprite(PIXI.Texture.WHITE);
            // Set it to fill the screen
            endBg.width = app.screen.width;
            endBg.height = app.screen.height;
            endBg.x = - app.screen.width / 2
            endBg.y = - app.screen.height / 2
            endBg.tint = 0x000000
            endBg.alpha = 0.75
            scenes.gameScene.ui.endGameContainer.addChild(endBg)

            const text = new PIXI.Text(
                "",
                {
                    ...textStyle,
                    fill: 0xffffff
                });
            text.y = - 270
            text.anchor.set(0.5, 0.5);
            scenes.gameScene.ui.endGameContainer.addChild(text)



            const restartButton = CreateButton(200, 1, "Try\nAgain", 40, () => { app.ticker.remove(EndTick); InitGame() })
            restartButton.x = 125
            restartButton.y = - 100
            scenes.gameScene.ui.endGameContainer.addChild(restartButton)

            const menuButton = CreateButton(200, 3, "Level\nSelect", 40, () => { scenes.ChangeScene("menu") })
            menuButton.x = - 125
            menuButton.y = - 100
            scenes.gameScene.ui.endGameContainer.addChild(menuButton)

            const nextLevelButton = CreateButton(200, 4, "Next\nLevel", 40, () => {
                currentLevelNum++;
                if (currentLevelNum < levels.length) {
                    app.ticker.remove(EndTick)
                    InitGame()
                }
            })
            nextLevelButton.y = 140
            nextLevelButton.x = 0
            scenes.gameScene.ui.endGameContainer.addChild(nextLevelButton)


            scenes.gameScene.ui.endGameContainer.show = (type) => {
                app.ticker.add(EndTick)
                scenes.gameScene.ui.addChild(scenes.gameScene.ui.endGameContainer)
                switch (type) {
                    case "lose":
                        nextLevelButton.alpha = 0.25
                        nextLevelButton.graphic.interactive = false
                        nextLevelButton.graphic.buttonMode = false
                        text.text = "You Lost!"
                        break
                    case "win":
                        if (levels[currentLevelNum + 1]) {
                            nextLevelButton.alpha = 1
                            nextLevelButton.graphic.interactive = true
                            nextLevelButton.graphic.buttonMode = true
                        } else {
                            nextLevelButton.alpha = 0.25
                            nextLevelButton.graphic.interactive = false
                            nextLevelButton.graphic.buttonMode = false
                        }
                        text.text = "You Won!"
                        break
                }
            }

            // GAME INFO 

            scenes.gameScene.ui.gameInfoContainer = new PIXI.Container()
            scenes.gameScene.ui.addChild(scenes.gameScene.ui.gameInfoContainer)

            const barHeight = scenes.gameScene.gameCanvas.y * 2
            const bar = new PIXI.Graphics()
            scenes.gameScene.ui.gameInfoContainer.addChild(bar)
            bar.beginFill(0x111111)
            bar.drawRect(0, 0, app.screen.width, barHeight)
            bar.endFill()

            const textSize = 50

            scenes.gameScene.ui.gameInfoContainer.levelNum = new PIXI.Text(
                "Level ?",
                {
                    ...textStyle,
                    fill: 0xffffff,
                    fontSize: textSize
                });
            scenes.gameScene.ui.gameInfoContainer.levelNum.anchor.set(0, 0.5)
            scenes.gameScene.ui.gameInfoContainer.levelNum.x = 25
            scenes.gameScene.ui.gameInfoContainer.levelNum.y = barHeight / 2
            scenes.gameScene.ui.gameInfoContainer.addChild(scenes.gameScene.ui.gameInfoContainer.levelNum)
            scenes.gameScene.ui.gameInfoContainer.levelNum.set = function (num) {
                this.text = "Level " + num
            }

            scenes.gameScene.ui.gameInfoContainer.levelDeaths = new PIXI.Text(
                "Level deaths: ?",
                {
                    ...textStyle,
                    fill: 0xffffff,
                    fontSize: textSize
                });
            scenes.gameScene.ui.gameInfoContainer.levelDeaths.anchor.set(0.5, 0.5)
            scenes.gameScene.ui.gameInfoContainer.levelDeaths.x = app.screen.width / 2
            scenes.gameScene.ui.gameInfoContainer.levelDeaths.y = barHeight / 2
            scenes.gameScene.ui.gameInfoContainer.addChild(scenes.gameScene.ui.gameInfoContainer.levelDeaths)
            scenes.gameScene.ui.gameInfoContainer.levelDeaths.set = function (num) {
                this.text = "Level deaths:  " + num
            }

            scenes.gameScene.ui.gameInfoContainer.totalDeaths = new PIXI.Text(
                "Total deaths: ?",
                {
                    ...textStyle,
                    fill: 0xffffff,
                    fontSize: textSize
                });
            scenes.gameScene.ui.gameInfoContainer.totalDeaths.anchor.set(1, 0.5)
            scenes.gameScene.ui.gameInfoContainer.totalDeaths.x = app.screen.width - 25
            scenes.gameScene.ui.gameInfoContainer.totalDeaths.y = barHeight / 2
            scenes.gameScene.ui.gameInfoContainer.addChild(scenes.gameScene.ui.gameInfoContainer.totalDeaths)
            scenes.gameScene.ui.gameInfoContainer.totalDeaths.set = function (num) {
                this.text = "Total deaths:  " + num
            }

        }

        const coinsCollectedBeforeGoal = []

        function AddDeath(levelNum) {
            levelNum = levelNum || currentLevelNum

            levels[levelNum].deaths = levels[levelNum].deaths + 1 || 1
            scenes.gameScene.ui.gameInfoContainer.levelDeaths.set(levels[levelNum].deaths)

            scenes.gameScene.deaths = scenes.gameScene.deaths + 1 || 1
            scenes.gameScene.ui.gameInfoContainer.totalDeaths.set(scenes.gameScene.deaths)
        }

        function HandlePlayerHitEnemy() {
            coinsCollectedBeforeGoal.forEach(coin => {
                scenes.gameScene.collactablesToGet++
                coin.alpha = 1
                coin.collected = false
            })

            AddDeath()
            scenes.gameScene.gameCanvas.player.Spawn()
        }

        const grid = PIXI.Sprite.from('sprites/gridpattern.png');
        grid.texture.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST

        const borderSize = 20
        function BuildGameMap(map, size) {

            scenes.gameScene.gameCanvas.elementsBg = new PIXI.Container()
            scenes.gameScene.gameCanvas.addChild(scenes.gameScene.gameCanvas.elementsBg)

            scenes.gameScene.gameCanvas.elements = new PIXI.Container()
            scenes.gameScene.gameCanvas.addChild(scenes.gameScene.gameCanvas.elements)

            const graphicBgBorder = new PIXI.Graphics()
            scenes.gameScene.gameCanvas.elementsBg.addChild(graphicBgBorder)
            graphicBgBorder.beginFill(0x000000);

            const graphicBgMask = new PIXI.Graphics()
            scenes.gameScene.gameCanvas.elementsBg.addChild(graphicBgMask)
            graphicBgMask.beginFill(0xFFFFFF);

            const tilingSprite = new PIXI.TilingSprite(
                grid.texture,
                app.screen.width,
                app.screen.height,
            );

            scenes.gameScene.gameCanvas.elementsBg.addChild(tilingSprite);

            tilingSprite.tileScale.x = size
            tilingSprite.tileScale.y = size

            //console.log(map)

            // debuging
            if (scenes.gameScene.defaultLevel) {
                scenes.gameScene.bg.removeChildren()
                for (let i = 0; i < app.screen.width; i += size * 2) {
                    const graphic = new PIXI.Graphics()
                    scenes.gameScene.bg.addChild(graphic)
                    const lineColor = i % (app.screen.width / 8) ? 0xFFFFFF : (i % (app.screen.width / 2) ? 0xFFFF00 : 0xFF5555)
                    graphic.lineStyle(5, lineColor, 0.5);
                    graphic.moveTo(i, 0);
                    graphic.lineTo(i, app.screen.height);
                }
                for (let j = 0; j < app.screen.height; j += size * 2) {
                    const graphic = new PIXI.Graphics()
                    scenes.gameScene.bg.addChild(graphic)
                    const lineColor = j % (app.screen.height / 6) ? 0xFFFFFF : 0xFFFF00
                    graphic.lineStyle(5, lineColor, 0.5);
                    graphic.moveTo(0, j);
                    graphic.lineTo(app.screen.width, j);
                }
            }

            tilingSprite.tint = 0xc0cccc

            map.forEach(element => {

                switch (element.type) {
                    case "ground":
                        graphicBgMask.drawRect(element.x, element.y, element.w, element.h)

                        // debugging
                        if (scenes.gameScene.defaultLevel) {
                            const graphic = new PIXI.Graphics()
                            scenes.gameScene.gameCanvas.elements.addChild(graphic)
                            graphic.beginFill(0x000000)
                            graphic.drawRect(element.x, element.y, element.w, element.h)
                            graphic.endFill()
                            graphic.alpha = 0.5
                        }

                        graphicBgMask.drawRect(element.x, element.y, element.w, element.h)
                        graphicBgBorder.drawRect(element.x - borderSize / 2, element.y - borderSize / 2, element.w + borderSize, element.h + borderSize)

                        break;
                    case "coin":
                        const coin = new PIXI.Graphics()
                        scenes.gameScene.gameCanvas.elements.addChild(coin)

                        element.r = size - 5
                        coin.lineStyle(7, 0x000000, 1);
                        coin.beginFill(colors[10])
                        coin.drawCircle(0, 0, element.r)
                        coin.endFill()

                        coin.x = element.x || element.xStart
                        coin.y = element.y || element.yStart

                        scenes.gameScene.collactablesToGet += 1
                        coin.collected = false

                        coin.onPlayerInside = () => {
                            if (!coin.collected) {
                                if (PlayerCollidesCircle(coin, element.r)) {
                                    // on player hit coin
                                    coin.collected = true
                                    scenes.gameScene.collactablesToGet--
                                    coin.alpha = 0

                                    coinsCollectedBeforeGoal.push(coin)
                                }
                            }
                        }

                        break;
                    case "goal":
                        const goal = new PIXI.Graphics()
                        scenes.gameScene.gameCanvas.elements.addChild(goal)

                        goal.beginFill(0x50dd50)
                        goal.drawRect(element.x, element.y, element.w, element.h)
                        goal.endFill()
                        goal.alpha = 0.75

                        goal.onPlayerInside = () => {
                            if (IsPlayerInsideRect(element)) {
                                scenes.gameScene.gameCanvas.player.startPos.x = scenes.gameScene.gameCanvas.player.x
                                scenes.gameScene.gameCanvas.player.startPos.y = scenes.gameScene.gameCanvas.player.y

                                coinsCollectedBeforeGoal.length = 0

                                if (IsGameWon()) HandleWin()
                            }
                        }
                        break;
                    case "enemy":
                        const enemy = new PIXI.Graphics()
                        const container = new PIXI.Container()
                        container.addChild(enemy)

                        scenes.gameScene.gameCanvas.elements.addChild(container)

                        enemy.lineStyle(7, 0x000000, 1);
                        enemy.beginFill(0x4040ff)

                        switch (element.shape) {
                            case "circle":
                                element.r = size - 5
                                enemy.drawCircle(0, 0, element.r)
                                container.x = element.x
                                container.y = element.y
                                if (element.rotation)
                                    container.rotation = element.rotation * (Math.PI / 180)

                                container.onPlayerInside = () => {
                                    if (PlayerCollidesCircle(enemy.toGlobal(new PIXI.Point(0, 0)), element.r, 0, 50)) {
                                        // on player hit enemy
                                        HandlePlayerHitEnemy()
                                    }
                                }

                                break
                            default:
                                console.log("ERROR: Unknown enemy shape: " + element.shape)
                                scenes.gameScene.gameCanvas.elements.removeChild(enemy)
                                break;
                        }
                        enemy.endFill()

                        const offset = element.offset || 0
                        const speed = element.speed || 10
                        switch (element.movement) {
                            case "linear":

                                enemy.x = offset

                                if (element.centered)
                                    container.movement = (deltaTime) => {
                                        var pos = (speed * gameData.enemyTime / 2 + offset) % (element.dist * 2)
                                        if (pos >= element.dist)
                                            enemy.x = element.dist - pos + element.dist / 2
                                        else
                                            enemy.x = pos - element.dist / 2
                                    }
                                else
                                    container.movement = (deltaTime) => {
                                        var pos = (speed * gameData.enemyTime / 2 + offset) % (element.dist * 2)
                                        if (pos >= element.dist)
                                            enemy.x = element.dist - pos
                                        else
                                            enemy.x = pos - element.dist
                                    }
                                break

                            case "circular":
                                //console.log(enemy.speed)

                                enemy.x = element.radius
                                const sign = element.invert ? -1 : 1

                                container.movement = (deltaTime) => {
                                    var rot = (speed * gameData.enemyTime / 4 + offset) % 360
                                    container.rotation = sign * rot * (Math.PI / 180)
                                }

                                break
                            default:
                                break
                        }

                        break

                        break
                    default:
                        console.log("ERROR: Unknown type: " + element.type)
                        break;
                }

            })

            graphicBgBorder.endFill();

            graphicBgMask.endFill();

            tilingSprite.mask = graphicBgMask
        }

        function InitGame(num) {
            if (scenes.currentScene !== scenes.gameScene)
                scenes.ChangeScene("game")

            if (num != undefined) {
                currentLevelNum = num
            }
            if (currentLevelNum >= levels.length) {
                console.log("ERROR: Level " + currentLevelNum + " does not exist")
                currentLevelNum = levels.length - 1
            }

            scenes.gameScene.gameCanvas.removeChildren()
            ResetUI()

            scenes.gameScene.ui.gameInfoContainer.levelNum.set(currentLevelNum + 1)
            scenes.gameScene.ui.gameInfoContainer.levelDeaths.set(levels[currentLevelNum].deaths || 0)
            scenes.gameScene.ui.gameInfoContainer.totalDeaths.set(scenes.gameScene.deaths || 0)

            scenes.gameScene.collactablesToGet = 0

            // draw map
            const map = levels[currentLevelNum].map || {}
            const size = levels[currentLevelNum].size || 25
            BuildGameMap(map, size)

            // draw player
            const player = levels[currentLevelNum].player || levels[0].player

            scenes.gameScene.gameCanvas.player = new PIXI.Container()
            scenes.gameScene.gameCanvas.addChild(scenes.gameScene.gameCanvas.player)


            const playerGraphic = new PIXI.Graphics()
            scenes.gameScene.gameCanvas.player.addChild(playerGraphic)

            //console.log(player)
            playerGraphic
                .beginFill(0xFFFFFF)
                .lineStyle(7, 0x000000, 1)
                .drawRect(0, 0, size * 2 - 3, size * 2 - 3)
                .endFill()

            playerGraphic.tint = 0xff2222
            scenes.gameScene.gameCanvas.player.startPos = {}
            playerGraphic.x -= size
            playerGraphic.y -= size

            scenes.gameScene.gameCanvas.player.SpawnAnimation = function (deltaTime) {
                scenes.gameScene.gameCanvas.player.scale.y += 0.05 * deltaTime
                scenes.gameScene.gameCanvas.player.scale.x += 0.05 * deltaTime

                if (scenes.gameScene.gameCanvas.player.scale.x >= 1) {
                    scenes.gameScene.gameCanvas.player.scale.y = 1
                    scenes.gameScene.gameCanvas.player.scale.x = 1
                    app.ticker.remove(scenes.gameScene.gameCanvas.player.SpawnAnimation)

                    scenes.gameScene.gameCanvas.player.canMove = true
                }
            }

            scenes.gameScene.gameCanvas.player.Spawn = function (x, y) {
                app.ticker.add(scenes.gameScene.gameCanvas.player.SpawnAnimation)

                scenes.gameScene.gameCanvas.player.scale.x = 0
                scenes.gameScene.gameCanvas.player.scale.y = 0
                scenes.gameScene.gameCanvas.player.canMove = false
                console.log("spawn player")


                this.x = x || this.startPos.x
                this.y = y || this.startPos.y

                this.startPos.x = this.x
                this.startPos.y = this.y
            }
            scenes.gameScene.gameCanvas.player.Spawn(player.x + 0.5, player.y + 0.5)

            //console.log(scenes.gameScene.gameCanvas.player)
        }

        function IsGameWon() {
            return scenes.gameScene.collactablesToGet == 0
        }

        function HandleWin() {
            scenes.gameScene.collactablesToGet = -1
            if (levels[currentLevelNum].canPlay != 10)
                levels[currentLevelNum].canPlay = 10

            const nextLevel = levels[currentLevelNum + 1]

            if (nextLevel)
                if (!nextLevel.canPlay)
                    levels[currentLevelNum + 1].canPlay = 1

            scenes.gameScene.ui.endGameContainer.show("win")
        }

        function GameTick(deltaTime) {

            // player movement
            var y = 0
            var x = 0
            if (keys[38] || keys[87])
                y -= 1
            if (keys[40] || keys[83])
                y += 1
            if (keys[37] || keys[65])
                x -= 1
            if (keys[39] || keys[68])
                x += 1

            if (!joystick.dragging)
                MovePlayer(x, y, deltaTime)


            scenes.gameScene.gameCanvas.elements.children.forEach(element => {
                if (element.movement)
                    element.movement(deltaTime)

                if (element.onPlayerInside)
                    element.onPlayerInside()
            })

        }


        //

        // MENU
        const colors = [
            // normal
            0x0000FF, // 0
            0x00FF00, // 1
            0xFF0000, // 2
            0x00FFFF, // 3
            0xFFFFFF, // 4
            0x0390FF, // 5
            0x000000, // 6
            0x000000, // 7
            0x000000, // 8
            0x000000, // 9
            // spetials
            0xFFD700, // 10
            0x000000, // 11
            0x000000, // 12
        ]

        CreateButton = (size, type, text, textSize, action) => {
            const button = new PIXI.Container()

            button.graphic = new PIXI.Graphics();
            button.graphic.beginFill(0xFFFFFF);
            button.graphic.drawRect(-size / 2, -size / 2, size, size);
            button.graphic.endFill();

            if (!PIXI.isMobile.any)
                button.graphic.filters = [new PIXI.filters.BlurFilter(2)]
            button.graphic.tint = colors[type]
            button.graphic.alpha = .85
            button.addChild(button.graphic)

            button.text = new PIXI.Text(
                text,
                {
                    ...textStyle,
                    fontSize: textSize
                });
            button.text.x = size / 2
            button.text.y = size / 2
            button.text.pivot.x = size / 2;
            button.text.pivot.y = size / 2;
            button.text.anchor.set(0.5, 0.5);
            button.addChild(button.text)

            /* 
                        app.ticker.add(() => {
                            button.rotation += 0.01
                        }) */

            button.graphic.interactive = true
            button.graphic.buttonMode = true
            button.graphic.on('pointerdown', action)


            return button;
        }

        const createMenu = () => {
            scenes.menuScene.removeChildren()

            const container = new PIXI.Container();
            scenes.menuScene.addChild(container)

            const nLevels = levels.length
            const sqrSize = Math.floor(Math.sqrt(nLevels))
            for (let i = 0; i < nLevels; i++) {
                const canPlay = levels[i] && levels[i].canPlay;

                const type = canPlay ? canPlay : -1
                const button = CreateButton(baseSize, type, i + 1, baseSize / 2, () => InitGame(i))
                if (!canPlay && !scenes.gameScene.canPlayAll) {
                    button.alpha = 0.5
                    button.graphic.interactive = false
                    button.graphic.buttonMode = false
                }
                button.x = (i % sqrSize) * baseSize * 1.2 + baseSize / 2;
                button.y = Math.floor(i / sqrSize) * baseSize * 1.2 + baseSize / 2;
                button.text.style.fill = 0xffffff
                container.addChild(button);
            }

            // Move container to the center
            container.x = app.screen.width / 2;
            container.y = app.screen.height / 2;

            // Center group
            container.pivot.x = container.width / 2;
            container.pivot.y = container.height / 2;

            /* const bg = new PIXI.Graphics().beginFill(0x8bc5ff).drawRect(0, 0, container.width, container.height).endFill()
            bg.alpha = 0.5
            container.addChild(bg) */

            const levelselectText = new PIXI.Text("Level Select", {
                ...textStyle,
                fill: 0xEFEFEF
            })
            levelselectText.anchor.set(0.5, 0.5);
            levelselectText.resolution = devicePixelRatio;
            levelselectText.x = app.screen.width / 2
            levelselectText.y = app.screen.height / 2 - container.height / 2 - 150


            scenes.menuScene.addChild(levelselectText)
        }

        PlayerMapCollisionX = (newX) => {
            if (newX == 0)
                return 0

            var isInside = false

            levels[currentLevelNum].map.forEach((e) => {
                if (e.type == "ground") {
                    if (IsPlayerInsideRect(e, newX, 0))
                        isInside = true

                }
            })

            if (isInside)
                return newX

            return PlayerMapCollisionX(Math.round(newX * 0.4))
        }

        PlayerMapCollisionY = (newY) => {
            if (newY == 0)
                return 0

            var isInside = false
            levels[currentLevelNum].map.forEach((e) => {
                if (e.type == "ground") {
                    if (IsPlayerInsideRect(e, 0, newY))
                        isInside = true
                }
            })
            if (isInside)
                return newY

            return PlayerMapCollisionY(Math.round(newY * 0.4))
        }

        function MovePlayer(x, y, deltaTime) {
            if (!scenes.gameScene.gameCanvas.player.canMove)
                return

            if (x != 0) {
                scenes.gameScene.gameCanvas.player.x += Math.round(PlayerMapCollisionX(x * playerSpeed * deltaTime))
            }
            if (y != 0) {
                scenes.gameScene.gameCanvas.player.y += Math.round(PlayerMapCollisionY(y * playerSpeed * deltaTime))

            }
        }

        createMenu()

        CreateUI()

        if (scenes.gameScene.defaultLevel)
            InitGame(scenes.gameScene.defaultLevel - 1)
        // 

        document.addEventListener('keydown', function (e) {
            if (!e.repeat) {
                keys = (keys || []);
                keys[e.keyCode] = true;
            }
        })
        document.addEventListener('keyup', function (e) {
            keys[e.keyCode] = false;
        })

        document.addEventListener("keydown", (e) => {
            //console.log(scenes.currentScene.sceneName)
            /* if (e.repeat)
                return; */

            switch (scenes.currentScene.sceneName) {
                case "menu":

                    switch (e.keyCode) {
                        case 49:
                        case 50:
                        case 51:
                        case 52:
                        case 53:
                        case 54:
                        case 55:
                        case 56:
                        case 57:
                            if (levels[e.key - 1])
                                if (levels[e.key - 1].canPlay)
                                    InitGame(e.key - 1)
                            break
                        case 32: // space
                            if (levels[currentLevelNum + 1])
                                InitGame(levels[currentLevelNum + 1].canPlay ? currentLevelNum + 1 : currentLevelNum)
                            else
                                InitGame(0)
                            break;
                        default: break;

                    }


                    break;
                case "game":

                    switch (e.keyCode) {
                        case 27: // esc
                            scenes.ChangeScene("menu")
                            break;

                        case 38: // up
                        case 87:
                            e.preventDefault()
                            break;
                        case 40: // down
                        case 83:
                            e.preventDefault()
                            break;
                        case 37: // left
                        case 65:
                            e.preventDefault()
                            break;
                        case 39: // right
                        case 68:
                            e.preventDefault()
                            break;
                        case 82: // r

                            if (!scenes.gameScene.gameCanvas.player.canMove)
                                break

                            app.ticker.remove(EndTick)
                            InitGame()
                            //reverse()
                            break;
                        case 32: // space
                            if (scenes.gameScene.collactablesToGet < 0) {
                                if (levels[currentLevelNum + 1])
                                    InitGame(levels[currentLevelNum + 1].canPlay ? currentLevelNum + 1 : currentLevelNum)
                                else
                                    scenes.ChangeScene("menu")
                            }
                            break
                        case 84: // t
                            scenes.gameScene.collactablesToGet = 0
                            break
                        default:
                            break
                    }

                    break;
                default: break;

            }
        })


    </script>
</body>

</html>